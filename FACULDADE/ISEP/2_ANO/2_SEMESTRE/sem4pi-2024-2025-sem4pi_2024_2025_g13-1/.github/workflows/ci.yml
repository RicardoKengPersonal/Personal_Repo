name: Java CI with Maven

on:
  push:
    branches: [ "main" ]
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  build:
    if: github.repository_owner == 'Departamento-de-Engenharia-Informatica'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: 'main'
          fetch-depth: 0

      - name: Set file permissions for Maven Wrapper
        run: chmod +x mvnw

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: maven

      - name: List Test Report Files (from submodules)
        run: find . -type d -name surefire-reports -exec ls -la {} \;

      - name: Build with Maven
        run: ./mvnw clean verify -Dmaven.test.failure.ignore=true

      - name: Generate Reports (Checkstyle, Jacoco)
        run: |
          ./mvnw surefire-report:report \
                checkstyle:checkstyle-aggregate \
                jacoco:report-aggregate \
                -Dmaven.test.failure.ignore=true

      - name: Archive Checkstyle and Test Results
        uses: actions/upload-artifact@v4
        with:
          name: test-and-checkstyle-report
          path: '**/target/site/'

      - name: JUnit Tests Report
        uses: phoenix-actions/test-reporting@v8
        id: test-report
        if: success() || failure()
        with:
          name: JUnit Tests Report
          fail-on-error: 'false'
          path: '**/target/surefire-reports/TEST-*.xml'
          reporter: java-junit

      - name: JaCoCo Code Coverage Report
        id: jacoco_reporter
        uses: PavanMudigonda/jacoco-reporter@v4.8
        with:
          coverage_results_path: target/site/jacoco-aggregate/jacoco.xml
          coverage_report_name: Coverage
          coverage_report_title: JaCoCo
          github_token: ${{ secrets.GITHUB_TOKEN }}
          skip_check_run: false
          minimum_coverage: 80
          fail_below_threshold: false
          publish_only_summary: false

      - name: Add Coverage Job Summary
        run: echo "${{ steps.jacoco_reporter.outputs.coverageSummary }}" >> $GITHUB_STEP_SUMMARY

      - name: Upload Code Coverage Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: test-code-coverage-report
          path: target/site/jacoco-aggregate/

      - name: Run gitinspector HTML process
        run: docker run --rm -v ${{ github.workspace }}:/repo felix/gitinspector:0.4.4 --format=html --grading > gitinspector.html

      - name: Upload Git Inspector HTML Report
        uses: actions/upload-artifact@v4
        with:
          name: gitinspector-report
          path: gitinspector.html

      - name: Run gitinspector TXT process
        run: docker run --rm -v ${{ github.workspace }}:/repo felix/gitinspector:0.4.4 --format=text --grading > gitinspector.txt

      - name: Add GitInspector TXT to Markdown Summary
        run: cat gitinspector.txt >> $GITHUB_STEP_SUMMARY

      - name: Update Dependency Graph
        uses: advanced-security/maven-dependency-submission-action@v3
        with:
          ignore-maven-wrapper: false
          snapshot-include-file-name: true
